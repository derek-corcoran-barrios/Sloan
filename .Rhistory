rownames(datos2015) <- gsub("New Orleans", "NOH", rownames(datos2015))
colnames(datos2015) <- gsub("Golden.State.Warriors", "GS", colnames(datos2015))
rownames(datos2015) <- gsub("Golden State", "GS", rownames(datos2015))
colnames(datos2015) <- gsub("Orlando.Magic", "ORL", colnames(datos2015))
rownames(datos2015) <- gsub("Orlando", "ORL", rownames(datos2015))
colnames(datos2015) <- gsub("Washington.Wizards", "WAS", colnames(datos2015))
rownames(datos2015) <- gsub("Washington", "WAS", rownames(datos2015))
colnames(datos2015) <- gsub("Philadelphia.76ers", "PHI", colnames(datos2015))
rownames(datos2015) <- gsub("Philadelphia", "PHI", rownames(datos2015))
colnames(datos2015) <- gsub("Brooklyn.Nets", "BKN", colnames(datos2015))
rownames(datos2015) <- gsub("Brooklyn", "BKN", rownames(datos2015))
colnames(datos2015) <- gsub("Utah.Jazz", "UTA", colnames(datos2015))
rownames(datos2015) <- gsub("Utah.Jazz", "UTA", rownames(datos2015))
colnames(datos2015) <- gsub("Miami.Heat", "MIA", colnames(datos2015))
rownames(datos2015) <- gsub("Miami", "MIA", rownames(datos2015))
colnames(datos2015) <- gsub("Charlotte.Hornets", "CHR", colnames(datos2015))
rownames(datos2015) <- gsub("Charlotte", "CHR", rownames(datos2015))
colnames(datos2015) <- gsub("Toronto.Raptors", "TOR", colnames(datos2015))
rownames(datos2015) <- gsub("Toronto", "TOR", rownames(datos2015))
colnames(datos2015) <- gsub("Indiana.Pacers", "IND", colnames(datos2015))
rownames(datos2015) <- gsub("Indiana", "IND", rownames(datos2015))
colnames(datos2015) <- gsub("Houston.Rockets", "HOU", colnames(datos2015))
rownames(datos2015) <- gsub("Houston", "HOU", rownames(datos2015))
colnames(datos2015) <- gsub("Denver.Nuggets", "DEN", colnames(datos2015))
rownames(datos2015) <- gsub("Denver", "DEN", rownames(datos2015))
colnames(datos2015) <- gsub("Memphis.Grizzlies", "MEM", colnames(datos2015))
rownames(datos2015) <- gsub("Memphis", "MEM", rownames(datos2015))
colnames(datos2015) <- gsub("New.York.Knicks", "NY", colnames(datos2015))
rownames(datos2015) <- gsub("New York", "NY", rownames(datos2015))
colnames(datos2015) <- gsub("Milwaukee.Bucks", "MIL", colnames(datos2015))
rownames(datos2015) <- gsub("Milwaukee", "MIL", rownames(datos2015))
colnames(datos2015) <- gsub("Oklahoma.City.Thunder", "OKC", colnames(datos2015))
rownames(datos2015) <- gsub("Oklahoma City", "OKC", rownames(datos2015))
colnames(datos2015) <- gsub("San.Antonio.Spurs", "SAN", colnames(datos2015))
rownames(datos2015) <- gsub("San Antonio", "SAN", rownames(datos2015))
colnames(datos2015) <- gsub("Dallas.Mavericks", "DAL", colnames(datos2015))
rownames(datos2015) <- gsub("Dallas", "DAL", rownames(datos2015))
colnames(datos2015) <- gsub("Phoenix.Suns", "PHO", colnames(datos2015))
rownames(datos2015) <- gsub("Phoenix", "PHO", rownames(datos2015))
colnames(datos2015) <- gsub("Portland.Trail.Blazers", "POR", colnames(datos2015))
rownames(datos2015) <- gsub("Portland", "POR", rownames(datos2015))
colnames(datos2015) <- gsub("Los.Angeles.Clippers", "LAC", colnames(datos2015))
rownames(datos2015) <- gsub("LA", "LAC", rownames(datos2015))
colnames(datos2015) <- gsub("Sacramento.Kings", "SAC", colnames(datos2015))
rownames(datos2015) <- gsub("Sacramento", "SAC", rownames(datos2015))
colnames(datos2015) <- gsub("Los.Angeles.Lakers", "LAL", colnames(datos2015))
rownames(datos2015) <- gsub("Los Angeles", "LAL", rownames(datos2015))
colnames(datos2015) <- gsub("Minnesota.Timberwolves", "MIN", colnames(datos2015))
rownames(datos2015) <- gsub("Minnesota", "MIN", rownames(datos2015))
colnames(datos2014) <- gsub("Detroit.Pistons", "DET", colnames(datos2014))
rownames(datos2014) <- gsub("Detroit", "DET", rownames(datos2014))
colnames(datos2014) <- gsub("Atlanta.Hawks", "ATL", colnames(datos2014))
rownames(datos2014) <- gsub("Atlanta", "ATL", rownames(datos2014))
colnames(datos2014) <- gsub("Chicago.Bulls", "CHI", colnames(datos2014))
rownames(datos2014) <- gsub("Chicago", "CHI", rownames(datos2014))
colnames(datos2014) <- gsub("Boston.Celtics", "BOS", colnames(datos2014))
rownames(datos2014) <- gsub("Boston", "BOS", rownames(datos2014))
colnames(datos2014) <- gsub("Cleveland.Cavaliers", "CLE", colnames(datos2014))
rownames(datos2014) <- gsub("Cleveland", "CLE", rownames(datos2014))
colnames(datos2014) <- gsub("New.Orleans.Pelicans", "NOH", colnames(datos2014))
rownames(datos2014) <- gsub("New Orleans", "NOH", rownames(datos2014))
colnames(datos2014) <- gsub("Golden.State.Warriors", "GS", colnames(datos2014))
rownames(datos2014) <- gsub("Golden State", "GS", rownames(datos2014))
colnames(datos2014) <- gsub("Orlando.Magic", "ORL", colnames(datos2014))
rownames(datos2014) <- gsub("Orlando", "ORL", rownames(datos2014))
colnames(datos2014) <- gsub("Washington.Wizards", "WAS", colnames(datos2014))
rownames(datos2014) <- gsub("Washington", "WAS", rownames(datos2014))
colnames(datos2014) <- gsub("Philadelphia.76ers", "PHI", colnames(datos2014))
rownames(datos2014) <- gsub("Philadelphia", "PHI", rownames(datos2014))
colnames(datos2014) <- gsub("Brooklyn.Nets", "BKN", colnames(datos2014))
rownames(datos2014) <- gsub("Brooklyn", "BKN", rownames(datos2014))
colnames(datos2014) <- gsub("Utah.Jazz", "UTA", colnames(datos2014))
rownames(datos2014) <- gsub("Utah.Jazz", "UTA", rownames(datos2014))
colnames(datos2014) <- gsub("Miami.Heat", "MIA", colnames(datos2014))
rownames(datos2014) <- gsub("Miami", "MIA", rownames(datos2014))
colnames(datos2014) <- gsub("Charlotte.Bobcats", "CHR", colnames(datos2014))
rownames(datos2014) <- gsub("Charlotte", "CHR", rownames(datos2014))
colnames(datos2014) <- gsub("Toronto.Raptors", "TOR", colnames(datos2014))
rownames(datos2014) <- gsub("Toronto", "TOR", rownames(datos2014))
colnames(datos2014) <- gsub("Indiana.Pacers", "IND", colnames(datos2014))
rownames(datos2014) <- gsub("Indiana", "IND", rownames(datos2014))
colnames(datos2014) <- gsub("Houston.Rockets", "HOU", colnames(datos2014))
rownames(datos2014) <- gsub("Houston", "HOU", rownames(datos2014))
colnames(datos2014) <- gsub("Denver.Nuggets", "DEN", colnames(datos2014))
rownames(datos2014) <- gsub("Denver", "DEN", rownames(datos2014))
colnames(datos2014) <- gsub("Memphis.Grizzlies", "MEM", colnames(datos2014))
rownames(datos2014) <- gsub("Memphis", "MEM", rownames(datos2014))
colnames(datos2014) <- gsub("New.York.Knicks", "NY", colnames(datos2014))
rownames(datos2014) <- gsub("New York", "NY", rownames(datos2014))
colnames(datos2014) <- gsub("Milwaukee.Bucks", "MIL", colnames(datos2014))
rownames(datos2014) <- gsub("Milwaukee", "MIL", rownames(datos2014))
colnames(datos2014) <- gsub("Oklahoma.City.Thunder", "OKC", colnames(datos2014))
rownames(datos2014) <- gsub("Oklahoma City", "OKC", rownames(datos2014))
colnames(datos2014) <- gsub("San.Antonio.Spurs", "SAN", colnames(datos2014))
rownames(datos2014) <- gsub("San Antonio", "SAN", rownames(datos2014))
colnames(datos2014) <- gsub("Dallas.Mavericks", "DAL", colnames(datos2014))
rownames(datos2014) <- gsub("Dallas", "DAL", rownames(datos2014))
colnames(datos2014) <- gsub("Phoenix.Suns", "PHO", colnames(datos2014))
rownames(datos2014) <- gsub("Phoenix", "PHO", rownames(datos2014))
colnames(datos2014) <- gsub("Portland.Trail.Blazers", "POR", colnames(datos2014))
rownames(datos2014) <- gsub("Portland", "POR", rownames(datos2014))
colnames(datos2014) <- gsub("Los.Angeles.Clippers", "LAC", colnames(datos2014))
rownames(datos2014) <- gsub("LA", "LAC", rownames(datos2014))
colnames(datos2014) <- gsub("Sacramento.Kings", "SAC", colnames(datos2014))
rownames(datos2014) <- gsub("Sacramento", "SAC", rownames(datos2014))
colnames(datos2014) <- gsub("Los.Angeles.Lakers", "LAL", colnames(datos2014))
rownames(datos2014) <- gsub("Los Angeles", "LAL", rownames(datos2014))
colnames(datos2014) <- gsub("Minnesota.Timberwolves", "MIN", colnames(datos2014))
rownames(datos2014) <- gsub("Minnesota", "MIN", rownames(datos2014))
colnames(datos2013) <- gsub("Detroit.Pistons", "DET", colnames(datos2013))
rownames(datos2013) <- gsub("Detroit", "DET", rownames(datos2013))
colnames(datos2013) <- gsub("Atlanta.Hawks", "ATL", colnames(datos2013))
rownames(datos2013) <- gsub("Atlanta", "ATL", rownames(datos2013))
colnames(datos2013) <- gsub("Chicago.Bulls", "CHI", colnames(datos2013))
rownames(datos2013) <- gsub("Chicago", "CHI", rownames(datos2013))
colnames(datos2013) <- gsub("Boston.Celtics", "BOS", colnames(datos2013))
rownames(datos2013) <- gsub("Boston", "BOS", rownames(datos2013))
colnames(datos2013) <- gsub("Cleveland.Cavaliers", "CLE", colnames(datos2013))
rownames(datos2013) <- gsub("Cleveland", "CLE", rownames(datos2013))
colnames(datos2013) <- gsub("New.Orleans.Pelicans", "NOH", colnames(datos2013))
rownames(datos2013) <- gsub("New Orleans", "NOH", rownames(datos2013))
colnames(datos2013) <- gsub("Golden.State.Warriors", "GS", colnames(datos2013))
rownames(datos2013) <- gsub("Golden State", "GS", rownames(datos2013))
colnames(datos2013) <- gsub("Orlando.Magic", "ORL", colnames(datos2013))
rownames(datos2013) <- gsub("Orlando", "ORL", rownames(datos2013))
colnames(datos2013) <- gsub("Washington.Wizards", "WAS", colnames(datos2013))
rownames(datos2013) <- gsub("Washington", "WAS", rownames(datos2013))
colnames(datos2013) <- gsub("Philadelphia.76ers", "PHI", colnames(datos2013))
rownames(datos2013) <- gsub("Philadelphia", "PHI", rownames(datos2013))
colnames(datos2013) <- gsub("Brooklyn.Nets", "BKN", colnames(datos2013))
rownames(datos2013) <- gsub("Brooklyn", "BKN", rownames(datos2013))
colnames(datos2013) <- gsub("Utah.Jazz", "UTA", colnames(datos2013))
rownames(datos2013) <- gsub("Utah.Jazz", "UTA", rownames(datos2013))
colnames(datos2013) <- gsub("Miami.Heat", "MIA", colnames(datos2013))
rownames(datos2013) <- gsub("Miami", "MIA", rownames(datos2013))
colnames(datos2013) <- gsub("Charlotte.Hornets", "CHR", colnames(datos2013))
rownames(datos2013) <- gsub("Charlotte", "CHR", rownames(datos2013))
colnames(datos2013) <- gsub("Toronto.Raptors", "TOR", colnames(datos2013))
rownames(datos2013) <- gsub("Toronto", "TOR", rownames(datos2013))
colnames(datos2013) <- gsub("Indiana.Pacers", "IND", colnames(datos2013))
rownames(datos2013) <- gsub("Indiana", "IND", rownames(datos2013))
colnames(datos2013) <- gsub("Houston.Rockets", "HOU", colnames(datos2013))
rownames(datos2013) <- gsub("Houston", "HOU", rownames(datos2013))
colnames(datos2013) <- gsub("Denver.Nuggets", "DEN", colnames(datos2013))
rownames(datos2013) <- gsub("Denver", "DEN", rownames(datos2013))
colnames(datos2013) <- gsub("Memphis.Grizzlies", "MEM", colnames(datos2013))
rownames(datos2013) <- gsub("Memphis", "MEM", rownames(datos2013))
colnames(datos2013) <- gsub("New.York.Knicks", "NY", colnames(datos2013))
rownames(datos2013) <- gsub("New York", "NY", rownames(datos2013))
colnames(datos2013) <- gsub("Milwaukee.Bucks", "MIL", colnames(datos2013))
rownames(datos2013) <- gsub("Milwaukee", "MIL", rownames(datos2013))
colnames(datos2013) <- gsub("Oklahoma.City.Thunder", "OKC", colnames(datos2013))
rownames(datos2013) <- gsub("Oklahoma City", "OKC", rownames(datos2013))
colnames(datos2013) <- gsub("San.Antonio.Spurs", "SAN", colnames(datos2013))
rownames(datos2013) <- gsub("San Antonio", "SAN", rownames(datos2013))
colnames(datos2013) <- gsub("Dallas.Mavericks", "DAL", colnames(datos2013))
rownames(datos2013) <- gsub("Dallas", "DAL", rownames(datos2013))
colnames(datos2013) <- gsub("Phoenix.Suns", "PHO", colnames(datos2013))
rownames(datos2013) <- gsub("Phoenix", "PHO", rownames(datos2013))
colnames(datos2013) <- gsub("Portland.Trail.Blazers", "POR", colnames(datos2013))
rownames(datos2013) <- gsub("Portland", "POR", rownames(datos2013))
colnames(datos2013) <- gsub("Los.Angeles.Clippers", "LAC", colnames(datos2013))
rownames(datos2013) <- gsub("LA", "LAC", rownames(datos2013))
colnames(datos2013) <- gsub("Sacramento.Kings", "SAC", colnames(datos2013))
rownames(datos2013) <- gsub("Sacramento", "SAC", rownames(datos2013))
colnames(datos2013) <- gsub("Los.Angeles.Lakers", "LAL", colnames(datos2013))
rownames(datos2013) <- gsub("Los Angeles", "LAL", rownames(datos2013))
colnames(datos2013) <- gsub("Minnesota.Timberwolves", "MIN", colnames(datos2013))
rownames(datos2013) <- gsub("Minnesota", "MIN", rownames(datos2013))
colnames(datos2012) <- gsub("Detroit.Pistons", "DET", colnames(datos2012))
rownames(datos2012) <- gsub("Detroit", "DET", rownames(datos2012))
colnames(datos2012) <- gsub("Atlanta.Hawks", "ATL", colnames(datos2012))
rownames(datos2012) <- gsub("Atlanta", "ATL", rownames(datos2012))
colnames(datos2012) <- gsub("Chicago.Bulls", "CHI", colnames(datos2012))
rownames(datos2012) <- gsub("Chicago", "CHI", rownames(datos2012))
colnames(datos2012) <- gsub("Boston.Celtics", "BOS", colnames(datos2012))
rownames(datos2012) <- gsub("Boston", "BOS", rownames(datos2012))
colnames(datos2012) <- gsub("Cleveland.Cavaliers", "CLE", colnames(datos2012))
rownames(datos2012) <- gsub("Cleveland", "CLE", rownames(datos2012))
colnames(datos2012) <- gsub("New.Orleans.Pelicans", "NOH", colnames(datos2012))
rownames(datos2012) <- gsub("New Orleans", "NOH", rownames(datos2012))
colnames(datos2012) <- gsub("Golden.State.Warriors", "GS", colnames(datos2012))
rownames(datos2012) <- gsub("Golden State", "GS", rownames(datos2012))
colnames(datos2012) <- gsub("Orlando.Magic", "ORL", colnames(datos2012))
rownames(datos2012) <- gsub("Orlando", "ORL", rownames(datos2012))
colnames(datos2012) <- gsub("Washington.Wizards", "WAS", colnames(datos2012))
rownames(datos2012) <- gsub("Washington", "WAS", rownames(datos2012))
colnames(datos2012) <- gsub("Philadelphia.76ers", "PHI", colnames(datos2012))
rownames(datos2012) <- gsub("Philadelphia", "PHI", rownames(datos2012))
colnames(datos2012) <- gsub("Brooklyn.Nets", "BKN", colnames(datos2012))
rownames(datos2012) <- gsub("Brooklyn", "BKN", rownames(datos2012))
colnames(datos2012) <- gsub("Utah.Jazz", "UTA", colnames(datos2012))
rownames(datos2012) <- gsub("Utah", "UTA", rownames(datos2012))
colnames(datos2012) <- gsub("Miami.Heat", "MIA", colnames(datos2012))
rownames(datos2012) <- gsub("Miami", "MIA", rownames(datos2012))
colnames(datos2012) <- gsub("Charlotte.Bobcats", "CHR", colnames(datos2012))
rownames(datos2012) <- gsub("Charlotte", "CHR", rownames(datos2012))
colnames(datos2012) <- gsub("Toronto.Raptors", "TOR", colnames(datos2012))
rownames(datos2012) <- gsub("Toronto", "TOR", rownames(datos2012))
colnames(datos2012) <- gsub("Indiana.Pacers", "IND", colnames(datos2012))
rownames(datos2012) <- gsub("Indiana", "IND", rownames(datos2012))
colnames(datos2012) <- gsub("Houston.Rockets", "HOU", colnames(datos2012))
rownames(datos2012) <- gsub("Houston", "HOU", rownames(datos2012))
colnames(datos2012) <- gsub("Denver.Nuggets", "DEN", colnames(datos2012))
rownames(datos2012) <- gsub("Denver", "DEN", rownames(datos2012))
colnames(datos2012) <- gsub("Memphis.Grizzlies", "MEM", colnames(datos2012))
rownames(datos2012) <- gsub("Memphis", "MEM", rownames(datos2012))
colnames(datos2012) <- gsub("New.York.Knicks", "NY", colnames(datos2012))
rownames(datos2012) <- gsub("New York", "NY", rownames(datos2012))
colnames(datos2012) <- gsub("Milwaukee.Bucks", "MIL", colnames(datos2012))
rownames(datos2012) <- gsub("Milwaukee", "MIL", rownames(datos2012))
colnames(datos2012) <- gsub("Oklahoma.City.Thunder", "OKC", colnames(datos2012))
rownames(datos2012) <- gsub("Oklahoma City", "OKC", rownames(datos2012))
colnames(datos2012) <- gsub("San.Antonio.Spurs", "SAN", colnames(datos2012))
rownames(datos2012) <- gsub("San Antonio", "SAN", rownames(datos2012))
colnames(datos2012) <- gsub("Dallas.Mavericks", "DAL", colnames(datos2012))
rownames(datos2012) <- gsub("Dallas", "DAL", rownames(datos2012))
colnames(datos2012) <- gsub("Phoenix.Suns", "PHO", colnames(datos2012))
rownames(datos2012) <- gsub("Phoenix", "PHO", rownames(datos2012))
colnames(datos2012) <- gsub("Portland.Trail.Blazers", "POR", colnames(datos2012))
rownames(datos2012) <- gsub("Portland", "POR", rownames(datos2012))
colnames(datos2012) <- gsub("Los.Angeles.Clippers", "LAC", colnames(datos2012))
rownames(datos2012) <- gsub("LA", "LAC", rownames(datos2012))
colnames(datos2012) <- gsub("Sacramento.Kings", "SAC", colnames(datos2012))
rownames(datos2012) <- gsub("Sacramento", "SAC", rownames(datos2012))
colnames(datos2012) <- gsub("Los.Angeles.Lakers", "LAL", colnames(datos2012))
rownames(datos2012) <- gsub("Los Angeles", "LAL", rownames(datos2012))
colnames(datos2012) <- gsub("Minnesota.Timberwolves", "MIN", colnames(datos2012))
rownames(datos2012) <- gsub("Minnesota", "MIN", rownames(datos2012))
NBAOdds$defAPPS <- NA
NBAOdds$offAPPS <- NA
datos <- list(datos2012 = datos2012 ,datos2013 = datos2013, datos2014 = datos2014, datos2015 = datos2015, datos2016= datos2016)
for (i in 1:nrow(NBAOdds)) {
print(i)
if (NBAOdds$Year[i] == 2016){
NBAOdds$offAPPS[i]<- datos$datos2016[rownames(datos$datos2016) == NBAOdds$Home[i],colnames(datos$datos2016) == NBAOdds$Away[i]]
NBAOdds$defAPPS[i] <- datos$datos2016[rownames(datos$datos2016) == NBAOdds$Away[i],colnames(datos$datos2016) == NBAOdds$Home[i]]
}
if (NBAOdds$Year[i] == 2015){
NBAOdds$offAPPS[i]<- datos$datos2015[rownames(datos$datos2015) == NBAOdds$Home[i],colnames(datos$datos2015) == NBAOdds$Away[i]]
NBAOdds$defAPPS[i] <- datos$datos2015[rownames(datos$datos2015) == NBAOdds$Away[i],colnames(datos$datos2015) == NBAOdds$Home[i]]
}
if (NBAOdds$Year[i] == 2014){
NBAOdds$offAPPS[i]<- datos$datos2014[rownames(datos$datos2014) == NBAOdds$Home[i],colnames(datos$datos2014) == NBAOdds$Away[i]]
NBAOdds$defAPPS[i] <- datos$datos2014[rownames(datos$datos2014) == NBAOdds$Away[i],colnames(datos$datos2014) == NBAOdds$Home[i]]
}
if (NBAOdds$Year[i] == 2013){
NBAOdds$offAPPS[i]<- datos$datos2013[rownames(datos$datos2013) == NBAOdds$Home[i],colnames(datos$datos2013) == NBAOdds$Away[i]]
NBAOdds$defAPPS[i] <- datos$datos2013[rownames(datos$datos2013) == NBAOdds$Away[i],colnames(datos$datos2013) == NBAOdds$Home[i]]
}
if (NBAOdds$Year[i] == 2012){
NBAOdds$offAPPS[i]<- datos$datos2012[rownames(datos$datos2012) == NBAOdds$Home[i],colnames(datos$datos2012) == NBAOdds$Away[i]]
NBAOdds$defAPPS[i] <- datos$datos2012[rownames(datos$datos2012) == NBAOdds$Away[i],colnames(datos$datos2012) == NBAOdds$Home[i]]
}
}
ggplot(NBAOdds, aes(x = Home.Spread, y = Diff)) + geom_point() + geom_smooth()
ggplot(NBAOdds, aes(x = defAPPS, y = Diff)) + geom_point() + geom_smooth()
ggplot(NBAOdds, aes(x = offAPPS, y = Diff)) + geom_point() + geom_smooth()
summary(lm(Diff ~ offAPPS + defAPPS, data=NBAOdds))
summary(lm(Diff ~ defAPPS, data=NBAOdds))
summary(lm(Diff ~ offAPPS, data=NBAOdds))
FinalOdds <- NBAOdds
write.csv(FinalOdds, "FinalOdds.csv")
####Regression trees
library(dismo)
library(gbm)
set.seed(123)
BRT <- gbm.step(NBAOdds, gbm.x = 14:15, gbm.y = 12, family = "gaussian", plot.main = TRUE, plot.folds = FALSE)
summary(BRT)
preds <- predict.gbm(BRT, NBAOdds2016, n.trees=BRT$gbm.call$best.trees, type="response")
preds
colnames(NBAOdds2016)
saveRDS(BRT, "BRT.rds")
BRT.rds
BRT
preds <- predict.gbm(BRT, NBAOdds2016, n.trees=BRT$gbm.call$best.trees, type="response")
predict.gbm(BRT, data.frame(defAPPS = -0.05, offAPPS = 1), n.trees=BRT$gbm.call$best.trees, type="response")
?predict.gbm
library(rjson)
library(grid)
library(gridExtra)
library(png)
library(RCurl)
library(ggplot2)
library(jpeg)
library(hexbin)
library(sp)
library(knitr)
library(raster)
library(rasterVis)
library(dplyr)
court <- readRDS("court.rds")
shotDatafDef2016 <- readRDS("shotDatafDef2016.rds")
shotDataTotal2016 <- readRDS("shotDataTotal2016.rds")
shotDatafDef2013 <- readRDS("shotDatafDef2013.rds")
shotDataTotal2013 <- readRDS("shotDataTotal2013.rds")
ShotComparisonGraph <- function(OffTeam, DefTown, SeasondataOff, SeasonDataDef, nbins = 30, maxsize = 7, quant = 0.7) {
#Filter the offensive data of the Offensive Team
Off <- filter(SeasondataOff, TEAM_NAME == OffTeam)
#Filter the Deffensive data of the Defensive team
deff <- SeasonDataDef[names(SeasonDataDef) == DefTown][[1]]
#Get the maximum and minumum values for x and y
xbnds <- range(c(SeasondataOff$LOC_X, deff$LOC_X))
ybnds <- range(c(SeasondataOff$LOC_Y, deff$LOC_Y))
#Make hexbin dataframes out of the teams
makeHexData <- function(df) {
h <- hexbin(df$LOC_X, df$LOC_Y, nbins, xbnds = xbnds, ybnds = ybnds, IDs = TRUE)
data.frame(hcell2xy(h),
PPS = tapply(as.numeric(as.character(df$SHOT_MADE_FLAG))*ifelse(tolower(df$SHOT_TYPE) == "3pt field goal", 3, 2), h@cID, FUN = function(z) sum(z)/length(z)),
ST = tapply(df$SHOT_MADE_FLAG, h@cID, FUN = function(z) length(z)),
cid = h@cell)
}
##Total NBA data
Totalhex <- makeHexData(SeasondataOff)
##Defensive team data
Defhex <- makeHexData(deff)
##Offensive team data
Offhex <- makeHexData(Off)
#Merge offensive and deffensive data with total data by Cell id
DeffbyCell <- merge(Totalhex, Defhex, by = "cid", all = T)
OffByCell <- merge(Totalhex, Offhex, by = "cid", all = T)
##  when calculating the difference empty cells should count as 0
DeffbyCell$PPS.x[is.na(DeffbyCell$PPS.x)] <- 0
DeffbyCell$PPS.y[is.na(DeffbyCell$PPS.y)] <- 0
DeffbyCell$ST.y[is.na(DeffbyCell$ST.y)] <- 0
OffByCell$PPS.x[is.na(OffByCell$PPS.x)] <- 0
OffByCell$PPS.y[is.na(OffByCell$PPS.y)] <- 0
OffByCell$ST.y[is.na(OffByCell$ST.y)] <- 0
#  make a "difference" data.frame
DiffDeff <- data.frame(x = ifelse(is.na(DeffbyCell$x.x), DeffbyCell$x.y, DeffbyCell$x.x),
y = ifelse(is.na(DeffbyCell$y.x), DeffbyCell$y.y, DeffbyCell$y.x),
PPS= DeffbyCell$PPS.y - DeffbyCell$PPS.x,
cid= DeffbyCell$cid,
ST = DeffbyCell$ST.y)
DiffOff <- data.frame(x = ifelse(is.na(OffByCell$x.x), OffByCell$x.y, OffByCell$x.x),
y = ifelse(is.na(OffByCell$y.x), OffByCell$y.y, OffByCell$y.x),
PPS= OffByCell$PPS.y - OffByCell$PPS.x,
ST = OffByCell$ST.x,
cid = OffByCell$cid,
ST = OffByCell$ST.y)
#make team comparisons
Comparison <- merge(DiffOff, DiffDeff, by = "cid", all = T)
Comparison <- Comparison[,-c(6:7)]
Comparison$Diff <- c(Comparison$PPS.x + Comparison$PPS.y)
PPSAA <- weighted.mean((Comparison$PPS.x + Comparison$PPS.y), Comparison$ST.x)
#Legend extractor
g_legend <- function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}
OFFLEG <- ggplot(DiffOff) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) +scale_colour_gradientn(colours = rainbow(7)) + ylim(c(-51, 400))+ theme(legend.position="bottom") +  ggtitle(paste(OffTeam, "Offensive\n Shot Chart", sep = " "))
leg<-g_legend(OFFLEG)
DiffOff <- filter(DiffOff, ST > quantile(DiffOff$ST, probs = quant))
DiffDeff <- filter(DiffDeff, ST > quantile(DiffDeff$ST, probs = quant))
Comparison <- filter(Comparison, ST.x > quantile(Comparison$ST.x, probs = quant))
OFF <- ggplot(DiffOff) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_colour_gradientn(colours = rainbow(7)) + ylim(c(-51, 400))+ theme(legend.position="none") +  ggtitle(paste(OffTeam, "Offensive\n Shot Chart", sep = " "))
DEF <- ggplot(DiffDeff)  + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_colour_gradientn(colours = rainbow(7)) + ylim(c(-51, 400))+ theme(legend.position="none") + ggtitle(paste(DefTown, "defensive\n Shot Chart", sep = " "))
COMP <- ggplot(Comparison) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x.x, y = y.x, color = Diff, size = ST.x), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_colour_gradientn(colours = rainbow(7)) + ylim(c(-51, 400))+ theme(legend.position="none") + ggtitle("Comparison\n Shot Chart")
charts <- arrangeGrob(DEF,OFF, COMP, ncol = 3)
p <- grid.arrange(arrangeGrob(arrangeGrob(DEF,OFF, COMP, ncol = 3),leg,ncol=1,heights=c(7/8,1/8)))
return(list(Off = DiffOff, deff = DiffDeff, Comparison = Comparison, Total = Totalhex, PPSAA = PPSAA, p = p, leg = leg, charts = charts))
}
Com1 <- ShotComparisonGraph(OffTeam = "San Antonio Spurs", DefTown = "Oklahoma City", SeasondataOff = shotDataTotal2016, SeasonDataDef = shotDatafDef2016, nbins = 30, quant = 0.7)
Com2 <- ShotComparisonGraph(OffTeam = "OKlahoma City Thunder", DefTown = "San Antonio", SeasondataOff = shotDataTotal2016, SeasonDataDef = shotDatafDef2016, nbins = 30, quant = 0.7)
grid.arrange(Com1$charts,Com2$charts,Com1$leg,ncol=1,heights=c(3/7, 3/7 ,1/7))
#scale_color_gradient2(low = "blue", high = "red", name = "APPS")
grid.arrange(Com1$charts,Com2$charts,Com1$leg,ncol=1,heights=c(3/7, 3/7 ,1/7))
library(rjson)
library(grid)
library(gridExtra)
library(png)
library(RCurl)
library(ggplot2)
library(jpeg)
library(hexbin)
library(sp)
library(knitr)
library(raster)
library(rasterVis)
library(dplyr)
court <- readRDS("court.rds")
shotDatafDef2016 <- readRDS("shotDatafDef2016.rds")
shotDataTotal2016 <- readRDS("shotDataTotal2016.rds")
shotDatafDef2013 <- readRDS("shotDatafDef2013.rds")
shotDataTotal2013 <- readRDS("shotDataTotal2013.rds")
ShotComparisonGraph <- function(OffTeam, DefTown, SeasondataOff, SeasonDataDef, nbins = 30, maxsize = 7, quant = 0.7) {
#Filter the offensive data of the Offensive Team
Off <- filter(SeasondataOff, TEAM_NAME == OffTeam)
#Filter the Deffensive data of the Defensive team
deff <- SeasonDataDef[names(SeasonDataDef) == DefTown][[1]]
#Get the maximum and minumum values for x and y
xbnds <- range(c(SeasondataOff$LOC_X, deff$LOC_X))
ybnds <- range(c(SeasondataOff$LOC_Y, deff$LOC_Y))
#Make hexbin dataframes out of the teams
makeHexData <- function(df) {
h <- hexbin(df$LOC_X, df$LOC_Y, nbins, xbnds = xbnds, ybnds = ybnds, IDs = TRUE)
data.frame(hcell2xy(h),
PPS = tapply(as.numeric(as.character(df$SHOT_MADE_FLAG))*ifelse(tolower(df$SHOT_TYPE) == "3pt field goal", 3, 2), h@cID, FUN = function(z) sum(z)/length(z)),
ST = tapply(df$SHOT_MADE_FLAG, h@cID, FUN = function(z) length(z)),
cid = h@cell)
}
##Total NBA data
Totalhex <- makeHexData(SeasondataOff)
##Defensive team data
Defhex <- makeHexData(deff)
##Offensive team data
Offhex <- makeHexData(Off)
#Merge offensive and deffensive data with total data by Cell id
DeffbyCell <- merge(Totalhex, Defhex, by = "cid", all = T)
OffByCell <- merge(Totalhex, Offhex, by = "cid", all = T)
##  when calculating the difference empty cells should count as 0
DeffbyCell$PPS.x[is.na(DeffbyCell$PPS.x)] <- 0
DeffbyCell$PPS.y[is.na(DeffbyCell$PPS.y)] <- 0
DeffbyCell$ST.y[is.na(DeffbyCell$ST.y)] <- 0
OffByCell$PPS.x[is.na(OffByCell$PPS.x)] <- 0
OffByCell$PPS.y[is.na(OffByCell$PPS.y)] <- 0
OffByCell$ST.y[is.na(OffByCell$ST.y)] <- 0
#  make a "difference" data.frame
DiffDeff <- data.frame(x = ifelse(is.na(DeffbyCell$x.x), DeffbyCell$x.y, DeffbyCell$x.x),
y = ifelse(is.na(DeffbyCell$y.x), DeffbyCell$y.y, DeffbyCell$y.x),
PPS= DeffbyCell$PPS.y - DeffbyCell$PPS.x,
cid= DeffbyCell$cid,
ST = DeffbyCell$ST.y)
DiffOff <- data.frame(x = ifelse(is.na(OffByCell$x.x), OffByCell$x.y, OffByCell$x.x),
y = ifelse(is.na(OffByCell$y.x), OffByCell$y.y, OffByCell$y.x),
PPS= OffByCell$PPS.y - OffByCell$PPS.x,
ST = OffByCell$ST.x,
cid = OffByCell$cid,
ST = OffByCell$ST.y)
#make team comparisons
Comparison <- merge(DiffOff, DiffDeff, by = "cid", all = T)
Comparison <- Comparison[,-c(6:7)]
Comparison$Diff <- c(Comparison$PPS.x + Comparison$PPS.y)
PPSAA <- weighted.mean((Comparison$PPS.x + Comparison$PPS.y), Comparison$ST.x)
#Legend extractor
g_legend <- function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}
OFFLEG <- ggplot(DiffOff) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) +scale_color_gradient2(low = "blue", high = "red", name = "APPS") + ylim(c(-51, 400))+ theme(legend.position="bottom") +  ggtitle(paste(OffTeam, "Offensive\n Shot Chart", sep = " "))
leg<-g_legend(OFFLEG)
DiffOff <- filter(DiffOff, ST > quantile(DiffOff$ST, probs = quant))
DiffDeff <- filter(DiffDeff, ST > quantile(DiffDeff$ST, probs = quant))
Comparison <- filter(Comparison, ST.x > quantile(Comparison$ST.x, probs = quant))
OFF <- ggplot(DiffOff) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_color_gradient2(low = "blue", high = "red", name = "APPS") + ylim(c(-51, 400))+ theme(legend.position="none") +  ggtitle(paste(OffTeam, "Offensive\n Shot Chart", sep = " "))
DEF <- ggplot(DiffDeff)  + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x, y = y, color = PPS, size = ST), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_color_gradient2(low = "blue", high = "red", name = "APPS") + ylim(c(-51, 400))+ theme(legend.position="none") + ggtitle(paste(DefTown, "defensive\n Shot Chart", sep = " "))
COMP <- ggplot(Comparison) + annotation_custom(court, -250, 250, -52, 418) + geom_point(aes(x = x.x, y = y.x, color = Diff, size = ST.x), stat = "identity") +
coord_fixed()  +theme(line = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
legend.title = element_blank(),
plot.title = element_text(size = 17, lineheight = 1.2, face = "bold"))+ scale_size(range = c(0, maxsize)) + scale_color_gradient2(low = "blue", high = "red", name = "APPS")+ ylim(c(-51, 400))+ theme(legend.position="none") + ggtitle("Comparison\n Shot Chart")
charts <- arrangeGrob(DEF,OFF, COMP, ncol = 3)
p <- grid.arrange(arrangeGrob(arrangeGrob(DEF,OFF, COMP, ncol = 3),leg,ncol=1,heights=c(7/8,1/8)))
return(list(Off = DiffOff, deff = DiffDeff, Comparison = Comparison, Total = Totalhex, PPSAA = PPSAA, p = p, leg = leg, charts = charts))
}
Com1 <- ShotComparisonGraph(OffTeam = "Golden State Warriors", DefTown = "Cleveland", SeasondataOff = shotDataTotal2016, SeasonDataDef = shotDatafDef2016, nbins = 30, quant = 0.7)
Com2 <- ShotComparisonGraph(OffTeam = "Cleveland Cavaliers", DefTown = "Golden State", SeasondataOff = shotDataTotal2016, SeasonDataDef = shotDatafDef2016, nbins = 30, quant = 0.7)
grid.arrange(Com1$charts,Com2$charts,Com1$leg,ncol=1,heights=c(3/7, 3/7 ,1/7))
